# Note: BFWindow(2) + gcc-2.95.3-glibc-2.2.5

.PHONY: normal bfwindow

all: clean normal bfwindow check
	@echo "INFO: please search keyword succeed/fail in the make log"

normal:
	arm-unknown-linux-gnu-gcc -static -o ghost.normal ghost.c >& ghost.normal.bld
	sim-outorder -config sa1core.cfg ghost.normal >& ghost.normal.log

bfwindow:
	make -f Makefile.bfw bld >& ghost.bfwindow.bld
	-make -f Makefile.bfw sim >& ghost.bfwindow.log

check:
	echo "INFO: check ghost.normal.log for keyword 'RESULT'..."
	@code=`grep "RESULT" ghost.normal.log | grep "Attack PASS" | wc -l`;   \
	if [ $${code} -eq 0 ]; then                                            \
	  echo "INFO: buffer overflow detection(normal) succeed";              \
	else                                                                   \
	  echo "INFO: buffer overflow detection(normal) fail";                 \
	fi
	echo "INFO: check ghost.bfwindow.log for keyword 'RESULT'..."
	@code=`grep "RESULT" ghost.bfwindow.log | grep "Attack PASS" | wc -l`; \
	if [ $${code} -eq 0 ]; then                                            \
	  echo "INFO: buffer overflow detection(bfwindow) succeed";            \
	else                                                                   \
	  echo "INFO: buffer overflow detection(bfwindow) fail";               \
	fi

clean:
	-rm -rf *.log simf *.cil.* *.dmp ghost.normal* *.o ghost.bfwindow* *.i
