DATASET ?= small
PFX     ?= ${ARMCC_HOME}/bin/arm-unknown-linux-gnu-
GCC     ?= $(PFX)gcc
STRIP   ?= $(PFX)strip
OD      ?= $(PFX)objdump

ifeq ($(PFX),)
CILPFX   =
CFLAGS   = -O0
CC_DRV   = $(GCC)
else
CILPFX   = cilly --doBFWindow --save-temps --gcc=$(GCC) -I${BFW_HOME} -I./_install/include -L./_install/lib
CFLAGS   = -O0 -static
CC_DRV   = $(CILPFX)
endif
KEY      ?= 1234567890abcdeffedcba09876543211234567890abcdeffedcba0987654321

RPT_PFX  = BFW_RES

BFW_MODE ?= light
CFG      ?= sa1core.cfg

ifeq ($(PFX),)
SIM_PFX = 
else
SIM_PFX = sim-outorder -config $(CFG)
endif

.PHONY: all clean bld sim rpt sim_rpt

all: clean bld sim

bld: bfw_prot bfw_lib ssl_write_hostname_ext_o
	$(CC_DRV) $(CFLAGS) ssl_write_hostname_ext.o -o ssl_write_hostname_ext.bfwindow -L${BFW_HOME} -lbfw -lm -lmbedtls -lmbedx509 -lmbedcrypto

ssl_write_hostname_ext_o: ssl_write_hostname_ext.c
	$(CC_DRV) $(CFLAGS) -DBFWINDOW_PROT -c $<

sim: ssl_write_hostname_ext.bfwindow
	$(SIM_PFX) ./ssl_write_hostname_ext.bfwindow

bfw_lib:
	make -C ${BFW_HOME} PFX=$(PFX)

bfw_prot:
	cp -f bfw/$(BFW_MODE)_lbuf_prot.cfg bfwindow.cfg
	cp -f bfw/$(BFW_MODE)_lbuf_prot.map bfwindow.map

clean:
	make -C ${BFW_HOME} PFX=$(PFX) clean
	-rm -rf *.bfwindow *.dmp *.o *.log report *.cil.* *.diff bfwindow.cfg bfwindow.map output_* *.i
