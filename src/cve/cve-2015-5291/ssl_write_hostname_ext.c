#include "mbedtls/debug.h"
#include "mbedtls/ssl.h"
#include "mbedtls/error.h"
#ifdef BFWINDOW_PROT
  #include "bfwindow.h"
#endif

#include <string.h>

#ifdef BFWINDOW_PROT
  #define PAD_GUARD 1
#else
  #define PAD_GUARD 0
#endif

int main( void )
{
    mbedtls_ssl_context ssl;
    mbedtls_ssl_config conf;
	// User input hostname string
	char hostname[MBEDTLS_SSL_MAX_CONTENT_LEN+4] = "https://github.com/rynxr/BFWindow";
	//Buffer for hostname for ssl context
	char *phostname_buffer = NULL; 
	//Buffer for other data
	char *pvictim_buffer   = NULL;
	char *pbuffer          = NULL;
	int hostname_len, len;
    int i, ret;

	// set hostname
	len = strlen(hostname);
	for (i=len; i<sizeof(hostname); i++)
	{
	  hostname[i] = 'M';
	}
	hostname[sizeof(hostname)-1] = '\0';

	// create target buffers
	pbuffer = (char *)calloc(MBEDTLS_SSL_MAX_CONTENT_LEN+PAD_GUARD+32+PAD_GUARD, sizeof(char));
	if (NULL == pbuffer)
	{
	  printf("RESULT: Buffer FAIL\n");
	  exit(0);
	}
	phostname_buffer = pbuffer;
	pvictim_buffer   = pbuffer + MBEDTLS_SSL_MAX_CONTENT_LEN+PAD_GUARD;
	for (i=0; i<(32+PAD_GUARD); i++) {
	  pvictim_buffer[i] = 'N';
	}
	pvictim_buffer[32+PAD_GUARD-1] = '\0';
#ifdef BFWINDOW_PROT
	bfw_setp_imp_range(phostname_buffer, &phostname_buffer[MBEDTLS_SSL_MAX_CONTENT_LEN+PAD_GUARD-1]);
	bfw_clrp_imp_range(pvictim_buffer, &pbuffer[MBEDTLS_SSL_MAX_CONTENT_LEN+PAD_GUARD+8+PAD_GUARD-1]);
#endif

	printf("hostname_buffer[end]: 0x%08x\n", &phostname_buffer[MBEDTLS_SSL_MAX_CONTENT_LEN+PAD_GUARD-1]);
	printf("victim_buffe[begin] : 0x%08x\n", pvictim_buffer);
	printf("victim_buffer(before attack): %s\n", pvictim_buffer);
	
    mbedtls_ssl_init( &ssl );
    mbedtls_ssl_config_init( &conf );

	if((ret = mbedtls_ssl_setup(&ssl, &conf)) != 0)
    {
        printf("RESULT: ssl_setup FAIL\n");
    }

    if((ret = mbedtls_ssl_set_hostname(&ssl, hostname)) != 0)
    {
        printf("RESULT: ssl_hostname FAIL\n");
    }


	ssl_write_hostname_ext(&ssl, phostname_buffer, &hostname_len); //Note: Attack occurs here

	printf("victim_buffer(after  attack): %s\n", pvictim_buffer);
	pvictim_buffer[32+PAD_GUARD-1] = '\0';
	len = strlen(pvictim_buffer);
	for (i=0; i<len; i++)
	{
	  if (pvictim_buffer[i] != 'N') break;
	}

	if (i<len)
	  printf("RESULT: Attack PASS\n");
	else
	  printf("RESULT: Attack FAIL\n");


    mbedtls_ssl_free(&ssl);
    mbedtls_ssl_config_free(&conf);
	free(pbuffer);

	printf("INFO: ssl_write_hostname_ext_attack DONE\n");

	return 0;
}
